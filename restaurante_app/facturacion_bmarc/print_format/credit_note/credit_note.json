{
 "absolute_value": 0,
 "align_labels_right": 0,
 "creation": "2025-09-24 12:49:50.661201",
 "css": "/* === Encabezado: estilos === */\r\n.header-wrap {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  gap: 15px;\r\n  align-items: flex-start;\r\n  margin-bottom: 20px;\r\n}\r\n\r\n/* Columna izquierda (empresa) */\r\n.col-izq {\r\n  width: 48%;\r\n  float: left;\r\n  text-align: justify;\r\n}\r\n\r\n/* Logo centrado y proporcionado */\r\n.logo-container {\r\n  text-align: center;\r\n  margin-bottom: 8px;\r\n}\r\n.company-logo {\r\n  max-height: 120px;   /* Ajusta si deseas m\u00e1s/menos alto */\r\n  max-width: 220px;   /* Limita el ancho m\u00e1ximo */\r\n  height: auto;\r\n  width: auto;\r\n}\r\n\r\n/* Nombre de empresa destacado */\r\n.company-name {\r\n  font-size: 14px;\r\n  font-weight: bold;\r\n  margin-bottom: 4px;\r\n}\r\n\r\n/* Datos de empresa compactos */\r\n.company-data {\r\n  font-size: 11px;\r\n  line-height: 1.4;\r\n}\r\n\r\n/* Columna derecha (SRI / Factura) */\r\n.col-der {\r\n  width: 48%;\r\n  float: right;\r\n  border: 1px solid #000;\r\n  padding: 10px;\r\n  font-size: 10px;\r\n  background-color: #f3f3f3;\r\n  text-align: center;\r\n}\r\n\r\n/* T\u00edtulo \u201cFACTURA\u201d */\r\n.factura-title {\r\n  font-size: 14px;\r\n  font-weight: bold;\r\n  margin: 2px 0 6px;\r\n}\r\n\r\n/* Clave de acceso en Code128 */\r\n.clave-acceso {\r\n  font-family: 'Code128';\r\n  font-size: 28px;\r\n  text-align: center;\r\n  white-space: nowrap;\r\n  overflow: hidden;\r\n  line-height: 1;\r\n  margin-top: 10px;\r\n}\r\n.clave-acceso-texto {\r\n  font-size: 9px;\r\n  margin-top: 4px;\r\n}\r\n",
 "custom_format": 1,
 "default_print_language": "es-EC",
 "disabled": 0,
 "doc_type": "Credit Note",
 "docstatus": 0,
 "doctype": "Print Format",
 "font_size": 14,
 "html": "{# ==== Company & Customer ==== #}\r\n{% set company = frappe.get_doc('Company', doc.company_id) %}\r\n{% set customer = frappe.get_doc('Cliente', doc.customer) if doc.customer else None %}\r\n{% set comp = doc.get_context() %}\r\n<style>\r\n  @page { size: A4; margin: 1.5cm; }\r\n  @font-face {\r\n    font-family: 'Code128';\r\n    src: url('{{ frappe.utils.get_url() }}/assets/restaurante_app/fonts/code128.ttf') format('truetype');\r\n  }\r\n  .t { border: 1px solid #ccc; padding: 5px; }\r\n</style>\r\n\r\n{# =======================\r\n   ACUMULADORES DE IVA\r\n   ======================= #}\r\n{% set ns = namespace(\r\n  base0=0.0, base5=0.0, base12=0.0, base13=0.0, base14=0.0, base15=0.0,\r\n  iva0=0.0,  iva5=0.0,  iva12=0.0,  iva13=0.0,  iva14=0.0,  iva15=0.0,\r\n  subtotal=0.0, ivatotal=0.0\r\n) %}\r\n\r\n{# ==== Helpers visuales ==== #}\r\n{% set access_key   = (doc.access_key or doc.clave_acceso or '') %}\r\n{% set estab        = (doc.estab or company.establishmentcode or '001') %}\r\n{% set ptoemi       = (doc.ptoemi or company.emissionpoint or '001') %}\r\n{% set secuencial   = (doc.secuencial or '000000001') %}\r\n{% set fecha_emis   = doc.posting_date %}\r\n{% set fecha_aut    = doc.authorization_datetime or '' %}\r\n{% set amb_raw      = (doc.environment or '') %}\r\n{% set ambiente     =\r\n      'PRODUCCI\u00d3N' if amb_raw in ['2','PRODUCCION','Producci\u00f3n','PRODUCCI\u00d3N'] else\r\n      'PRUEBAS'    if amb_raw in ['1','PRUEBAS','Pruebas'] else\r\n      (amb_raw or 'DESCONOCIDO') %}\r\n\r\n<!-- === ENCABEZADO === -->\r\n<div class=\"header-wrap\">\r\n  <!-- Columna Empresa -->\r\n  <div class=\"col-izq\">\r\n    <div class=\"logo-container\">\r\n      <img src=\"{{ company.logo or '/files/sin_logo.png' }}\" class=\"company-logo\">\r\n    </div>\r\n\r\n    <div class=\"company-name\">\r\n      {{ company.businessname }}\r\n    </div>\r\n\r\n    <div class=\"company-data\">\r\n      {{ company.address or '' }}<br>\r\n      Tel: {{ company.phone or '' }}<br>\r\n      Email: {{ company.email or '' }}<br>\r\n      Contribuyente Especial Nro: {{ company.contribuyente_especial or 'N/A' }}<br>\r\n      Obligado a llevar contabilidad: {{ 'SI' if company.obligado_a_llevar_contabilidad == 1 else 'NO' }}\r\n    </div>\r\n  </div>\r\n\r\n  <!-- Columna SRI / Factura -->\r\n  <div class=\"col-der\">\r\n    <div><strong>R.U.C.:</strong> {{ company.ruc }}</div>\r\n    <div class=\"factura-title\">NOTA DE CR\u00c9DITO</div>\r\n    <div><strong>No.:</strong> {{ estab }}-{{ ptoemi }}-{{ secuencial }}</div>\r\n\r\n    <div style=\"margin-top:6px;\"><strong>No. de Autorizaci\u00f3n:</strong></div>\r\n    <div>{{ access_key }}</div>\r\n\r\n    <div style=\"margin-top:6px;\"><strong>Fecha y hora de Autorizaci\u00f3n:</strong></div>\r\n    <div>{{ fecha_aut }}</div>\r\n\r\n    <p style=\"margin:6px 0 0;\"><strong>Ambiente:</strong> {{ ambiente }}</p>\r\n    <div><strong>Emisi\u00f3n:</strong> NORMAL</div>\r\n\r\n    <div style=\"margin-top:8px;\"><strong>CLAVE DE ACCESO</strong></div>\r\n    <div class=\"clave-acceso\">{{ access_key }}</div>\r\n    <div class=\"clave-acceso-texto\">{{ access_key }}</div>\r\n  </div>\r\n</div>\r\n\r\n\r\n<!-- Cliente -->\r\n<table style=\"width:100%; border-collapse:collapse; font-size:10px; margin-top:10px; page-break-inside:avoid;\">\r\n  <tbody>\r\n    <tr>\r\n      <td class=\"t\">\r\n        <strong>Raz\u00f3n Social / Nombres:</strong>\r\n        {{ (doc.customer_name or (customer.nombre if customer else '')) | default('') }}\r\n      </td>\r\n      <td class=\"t\">\r\n        <strong>Fecha Emisi\u00f3n:</strong>\r\n        {% if fecha_emis %}{{ frappe.utils.formatdate(fecha_emis) if frappe and frappe.utils else fecha_emis }}{% endif %}\r\n      </td>\r\n    </tr>\r\n    <tr>\r\n      <td class=\"t\">\r\n        <strong>Identificaci\u00f3n:</strong>\r\n        {{ (doc.customer_tax_id or (customer.num_identificacion if customer else '')) | default('') }}\r\n      </td>\r\n      <td class=\"t\">\r\n        <strong>Direcci\u00f3n:</strong>\r\n        {{ ((customer.direccion if customer else '') or '') | default('') }}\r\n      </td>\r\n    </tr>\r\n    <tr>\r\n      <td class=\"t\">\r\n        <strong>Email:</strong>\r\n        {{ (doc.customer_email or (customer.correo if customer else '')) | default('') }}\r\n      </td>\r\n      <td class=\"t\">\r\n        <strong>Tel\u00e9fono:</strong>\r\n        {{ ((customer.telefono if customer else '') or '') | default('') }}\r\n      </td>\r\n    </tr>\r\n\r\n    <!-- Separador / t\u00edtulo de secci\u00f3n -->\r\n    \r\n    <tr>\r\n      <td class=\"t\"  >\r\n        <strong>Comprobante que se modifica:</strong> FACTURA {{doc.secuencial_factura}}\r\n      </td>\r\n      <td class=\"t\">\r\n        <strong>Fecha de Emisi\u00f3n (Comprobante a modificar):</strong>\r\n      {{  doc.posting_date_factura }}\r\n      </td>\r\n    </tr>\r\n    \r\n    <tr>\r\n      <td class=\"t\" colspan=\"2\">\r\n        <strong>Raz\u00f3n de Modificaci\u00f3n:</strong> {{ doc.motivo | default('') }}\r\n      </td>\r\n    </tr>\r\n  </tbody>\r\n</table>\r\n\r\n\r\n<!-- Detalle -->\r\n<table style=\"width:100%; border-collapse:collapse; font-size:10px; margin-top:10px; page-break-inside:avoid;\">\r\n  <thead>\r\n    <tr style=\"background-color:#eaeaea; font-weight:bold;\">\r\n      <th class=\"t\">C\u00f3digo</th>\r\n      <th class=\"t\">Cantidad</th>\r\n      <th class=\"t\">Descripci\u00f3n</th>\r\n      <th class=\"t\">Precio Unitario</th>\r\n      <th class=\"t\">Descuento</th>\r\n      <th class=\"t\">Subtotal</th>\r\n    </tr>\r\n  </thead>\r\n  <tbody>\r\n    {% for row in doc.items %}\r\n      {# === C\u00e1lculos por l\u00ednea ===\r\n         Preferimos tax_rate num\u00e9rico; si no existe, intentamos items.tax -> taxes.value #}\r\n      {% set pct = (row.tax_rate if row.tax_rate is not none else (frappe.db.get_value('taxes', row.tax, 'value') if row.tax else 0)) | float %}\r\n      {% set qty = (row.qty or 0) | float %}\r\n      {% set rate = (row.rate or 0) | float %}\r\n      {% set disc = (row.discount_pct or 0) | float %}\r\n      {% if disc < 0 %}{% set disc = 0 %}{% endif %}\r\n      {% if disc > 100 %}{% set disc = 100 %}{% endif %}\r\n      {% set base = (qty * rate * (1 - (disc/100.0))) | float %}\r\n      {% set iva_line = (base * (pct/100.0)) | float %}\r\n\r\n      {# Acumular #}\r\n      {% set ns.subtotal = ns.subtotal + base %}\r\n      {% set ns.ivatotal = ns.ivatotal + iva_line %}\r\n      {% if pct|int == 0 %}\r\n        {% set ns.base0 = ns.base0 + base %}{% set ns.iva0 = ns.iva0 + iva_line %}\r\n      {% elif pct|int == 5 %}\r\n        {% set ns.base5 = ns.base5 + base %}{% set ns.iva5 = ns.iva5 + iva_line %}\r\n      {% elif pct|int == 12 %}\r\n        {% set ns.base12 = ns.base12 + base %}{% set ns.iva12 = ns.iva12 + iva_line %}\r\n      {% elif pct|int == 13 %}\r\n        {% set ns.base13 = ns.base13 + base %}{% set ns.iva13 = ns.iva13 + iva_line %}\r\n      {% elif pct|int == 14 %}\r\n        {% set ns.base14 = ns.base14 + base %}{% set ns.iva14 = ns.iva14 + iva_line %}\r\n      {% elif pct|int == 15 %}\r\n        {% set ns.base15 = ns.base15 + base %}{% set ns.iva15 = ns.iva15 + iva_line %}\r\n      {% endif %}\r\n\r\n      {% set desc_txt = row.item_name or row.description or row.item_code %}\r\n      <tr>\r\n        <td class=\"t\">{{ row.item_code }}</td>\r\n        <td class=\"t\" style=\"text-align:right;\">{{ qty }}</td>\r\n        <td class=\"t\">{{ desc_txt }}</td>\r\n        <td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(rate) }}</td>\r\n        <td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(((qty * rate) - base) if disc>0 else 0.0) }}</td>\r\n        <td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(base) }}</td>\r\n      </tr>\r\n    {% endfor %}\r\n  </tbody>\r\n</table>\r\n\r\n<!-- Pagos y Totales -->\r\n<div style=\"margin-top:15px; overflow:hidden;\">\r\n  <!-- Pagos -->\r\n  <div style=\"width:48%; float:left;\">\r\n    <table style=\"width:100%; border-collapse:collapse; font-size:10px;\">\r\n      <thead>\r\n        <tr style=\"background-color:#eaeaea; font-weight:bold;\">\r\n          <th class=\"t\">Forma de Pago</th>\r\n          <th class=\"t\">Valor</th>\r\n        </tr>\r\n      </thead>\r\n      <tbody>\r\n        {% if doc.payments and doc.payments|length > 0 %}\r\n          {% for p in doc.payments %}\r\n            <tr>\r\n              <td class=\"t\">{{ p.forma_pago or p.method or '\u2014' }}</td>\r\n              <td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(p.monto or doc.grand_total or (ns.subtotal + ns.ivatotal)) }}</td>\r\n            </tr>\r\n          {% endfor %}\r\n        {% else %}\r\n          <tr>\r\n            <td class=\"t\">Pago</td>\r\n            <td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(doc.grand_total if doc.grand_total is not none else (ns.subtotal + ns.ivatotal)) }}</td>\r\n          </tr>\r\n        {% endif %}\r\n      </tbody>\r\n    </table>\r\n  </div>\r\n\r\n  <!-- Totales -->\r\n  <div style=\"width:48%; float:right;\">\r\n    <table style=\"width:100%; border-collapse:collapse; font-size:10px;\">\r\n\r\n      {# Subtotales por tasa (solo si hay base) #}\r\n      {% if ns.base15 > 0 %}<tr><td class=\"t\">Subtotal 15%</td><td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(ns.base15) }}</td></tr>{% endif %}\r\n      {% if ns.base14 > 0 %}<tr><td class=\"t\">Subtotal 14%</td><td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(ns.base14) }}</td></tr>{% endif %}\r\n      {% if ns.base13 > 0 %}<tr><td class=\"t\">Subtotal 13%</td><td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(ns.base13) }}</td></tr>{% endif %}\r\n      {% if ns.base12 > 0 %}<tr><td class=\"t\">Subtotal 12%</td><td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(ns.base12) }}</td></tr>{% endif %}\r\n      {% if ns.base5  > 0 %}<tr><td class=\"t\">Subtotal 5%</td><td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(ns.base5) }}</td></tr>{% endif %}\r\n      {% if ns.base0  > 0 %}<tr><td class=\"t\">Subtotal 0%</td><td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(ns.base0) }}</td></tr>{% endif %}\r\n\r\n      <tr>\r\n        <td class=\"t\">Subtotal (sin impuestos)</td>\r\n        <td class=\"t\" style=\"text-align:right;\">\r\n          {{ \"%.2f\"|format(doc.total_without_tax if doc.total_without_tax is not none else ns.subtotal) }}\r\n        </td>\r\n      </tr>\r\n\r\n      <tr><td class=\"t\">Descuento</td><td class=\"t\" style=\"text-align:right;\">0.00</td></tr>\r\n\r\n      {# IVA por tasa (omite 0%) #}\r\n      {% if ns.iva15 > 0 %}<tr><td class=\"t\">IVA 15%</td><td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(ns.iva15) }}</td></tr>{% endif %}\r\n      {% if ns.iva14 > 0 %}<tr><td class=\"t\">IVA 14%</td><td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(ns.iva14) }}</td></tr>{% endif %}\r\n      {% if ns.iva13 > 0 %}<tr><td class=\"t\">IVA 13%</td><td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(ns.iva13) }}</td></tr>{% endif %}\r\n      {% if ns.iva12 > 0 %}<tr><td class=\"t\">IVA 12%</td><td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(ns.iva12) }}</td></tr>{% endif %}\r\n      {% if ns.iva5  > 0 %}<tr><td class=\"t\">IVA 5%</td><td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(ns.iva5) }}</td></tr>{% endif %}\r\n\r\n      <tr>\r\n        <td class=\"t\"><strong>Valor Total</strong></td>\r\n        <td class=\"t\" style=\"text-align:right;\">\r\n          <strong>{{ \"%.2f\"|format(doc.grand_total if doc.grand_total is not none else (ns.subtotal + ns.ivatotal)) }}</strong>\r\n        </td>\r\n      </tr>\r\n    </table>\r\n  </div>\r\n</div>\r\n",
 "idx": 0,
 "line_breaks": 0,
 "margin_bottom": 15.0,
 "margin_left": 15.0,
 "margin_right": 15.0,
 "margin_top": 15.0,
 "modified": "2025-09-24 14:35:27.554676",
 "modified_by": "Administrator",
 "module": "Facturacion BMARC",
 "name": "Credit Note",
 "owner": "Administrator",
 "page_number": "Hide",
 "pdf_generator": "wkhtmltopdf",
 "print_format_builder": 0,
 "print_format_builder_beta": 0,
 "print_format_type": "Jinja",
 "raw_printing": 0,
 "show_section_headings": 0,
 "standard": "Yes"
}