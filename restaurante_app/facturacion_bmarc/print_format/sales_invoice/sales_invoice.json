{
 "absolute_value": 0,
 "align_labels_right": 0,
 "creation": "2025-08-19 16:18:32.045578",
 "css": "",
 "custom_format": 1,
 "default_print_language": "es-EC",
 "disabled": 0,
 "doc_type": "Sales Invoice",
 "docstatus": 0,
 "doctype": "Print Format",
 "font_size": 14,
 "html": "{# ==== Company & Customer ==== #}\r\n{% set company = frappe.get_doc('Company', doc.company_id) %}\r\n{% set customer = frappe.get_doc('Cliente', doc.customer) if doc.customer else None %}\r\n{% set comp = doc.get_context() %}\r\n<style>\r\n  @page { size: A4; margin: 1.5cm; }\r\n  @font-face {\r\n    font-family: 'Code128';\r\n    src: url('{{ frappe.utils.get_url() }}/assets/restaurante_app/fonts/code128.ttf') format('truetype');\r\n  }\r\n  .t { border: 1px solid #ccc; padding: 5px; }\r\n</style>\r\n\r\n{# =======================\r\n   ACUMULADORES DE IVA\r\n   ======================= #}\r\n{% set ns = namespace(\r\n  base0=0.0, base5=0.0, base12=0.0, base13=0.0, base14=0.0, base15=0.0,\r\n  iva0=0.0,  iva5=0.0,  iva12=0.0,  iva13=0.0,  iva14=0.0,  iva15=0.0,\r\n  subtotal=0.0, ivatotal=0.0\r\n) %}\r\n\r\n{# ==== Helpers visuales ==== #}\r\n{% set access_key   = (doc.access_key or doc.clave_acceso or '') %}\r\n{% set estab        = (doc.estab or company.establishmentcode or '001') %}\r\n{% set ptoemi       = (doc.ptoemi or company.emissionpoint or '001') %}\r\n{% set secuencial   = (doc.secuencial or '000000001') %}\r\n{% set fecha_emis   = doc.fecha_emision or frappe.utils.formatdate(doc.posting_date or frappe.utils.nowdate(), 'dd/MM/yyyy') %}\r\n{% set fecha_aut    = (frappe.utils.format_datetime(doc.authorization_datetime, 'dd/MM/yyyy HH:mm') if doc.authorization_datetime else '') %}\r\n{% set amb_raw      = (doc.environment or '') %}\r\n{% set ambiente     =\r\n      'PRODUCCI\u00d3N' if amb_raw in ['2','PRODUCCION','Producci\u00f3n','PRODUCCI\u00d3N'] else\r\n      'PRUEBAS'    if amb_raw in ['1','PRUEBAS','Pruebas'] else\r\n      (amb_raw or 'DESCONOCIDO') %}\r\n\r\n<!-- ENCABEZADO -->\r\n<div style=\"display:flex; justify-content:space-between; gap:15px; align-items:flex-start; margin-bottom:20px;\">\r\n  <div style=\"margin-top:15px; overflow:hidden; width:100%;\">\r\n    <!-- EMPRESA -->\r\n    <div style=\"width:48%; float:left;\">\r\n      {% if company.logo %}\r\n        <img src=\"{{ company.logo }}\" style=\"max-height:60px; margin-bottom:5px;\"><br>\r\n      {% endif %}\r\n      <strong>{{ company.businessname }}</strong><br>\r\n      {{ company.address or '' }}<br>\r\n      Tel: {{ company.phone or '' }}<br>\r\n      Email: {{ company.email or '' }}<br>\r\n      Contribuyente Especial Nro: {{ company.contribuyente_especial or 'N/A' }}<br>\r\n      Obligado a llevar contabilidad: {{ 'SI' if company.obligado_a_llevar_contabilidad else 'NO' }}<br>\r\n    </div>\r\n\r\n    <!-- FACTURA / SRI -->\r\n    <div style=\"width:48%; float:right; border:1px solid #000; padding:10px; font-size:10px; background-color:#f3f3f3; text-align:center;\">\r\n      <div><strong>R.U.C.:</strong> {{ company.ruc }}</div>\r\n      <div style=\"font-size:14px; font-weight:bold;\">FACTURA</div>\r\n      <div><strong>No.:</strong> {{ estab }}-{{ ptoemi }}-{{ secuencial }}</div>\r\n\r\n      <div><strong>No. de Autorizaci\u00f3n:</strong></div>\r\n      <div>{{ access_key }}</div>\r\n\r\n      <div><strong>Fecha y hora de Autorizaci\u00f3n:</strong></div>\r\n      <div>{{ fecha_aut }}</div>\r\n\r\n      <p><strong>Ambiente:</strong> {{ ambiente }}</p>\r\n      <div><strong>Emisi\u00f3n:</strong> NORMAL</div>\r\n\r\n      <div><strong>CLAVE DE ACCESO</strong></div>\r\n      <div style=\"font-family:'Code128'; font-size:28px; text-align:center; white-space:nowrap; overflow:hidden; line-height:1; margin-top:10px;\">\r\n        {{ access_key }}\r\n      </div>\r\n      <div style=\"font-size:9px; margin-top:4px;\">{{ access_key }}</div>\r\n    </div>\r\n  </div>\r\n</div>\r\n\r\n<!-- Cliente -->\r\n<table style=\"width:100%; border-collapse:collapse; font-size:10px; margin-top:10px; page-break-inside:avoid;\">\r\n  <tr>\r\n    <td class=\"t\"><strong>Raz\u00f3n Social / Nombres:</strong> {{ doc.customer_name or (customer.nombre if customer else '') }}</td>\r\n    <td class=\"t\"><strong>Fecha Emisi\u00f3n:</strong> {{ fecha_emis }}</td>\r\n  </tr>\r\n  <tr>\r\n    <td class=\"t\"><strong>Identificaci\u00f3n:</strong> {{ doc.customer_tax_id or (customer.num_identificacion if customer else '') }}</td>\r\n    <td class=\"t\"><strong>Direcci\u00f3n:</strong> {{ (customer.direccion if customer else '') or '' }}</td>\r\n  </tr>\r\n  <tr>\r\n    <td class=\"t\"><strong>Email:</strong> {{ doc.customer_email or (customer.correo if customer else '') }}</td>\r\n    <td class=\"t\"><strong>Tel\u00e9fono:</strong> {{ (customer.telefono if customer else '') or '' }}</td>\r\n  </tr>\r\n</table>\r\n\r\n<!-- Detalle -->\r\n<table style=\"width:100%; border-collapse:collapse; font-size:10px; margin-top:10px; page-break-inside:avoid;\">\r\n  <thead>\r\n    <tr style=\"background-color:#eaeaea; font-weight:bold;\">\r\n      <th class=\"t\">C\u00f3digo</th>\r\n      <th class=\"t\">Cantidad</th>\r\n      <th class=\"t\">Descripci\u00f3n</th>\r\n      <th class=\"t\">Precio Unitario</th>\r\n      <th class=\"t\">Descuento</th>\r\n      <th class=\"t\">Subtotal</th>\r\n    </tr>\r\n  </thead>\r\n  <tbody>\r\n    {% for row in doc.items %}\r\n      {# === C\u00e1lculos por l\u00ednea ===\r\n         Preferimos tax_rate num\u00e9rico; si no existe, intentamos items.tax -> taxes.value #}\r\n      {% set pct = (row.tax_rate if row.tax_rate is not none else (frappe.db.get_value('taxes', row.tax, 'value') if row.tax else 0)) | float %}\r\n      {% set qty = (row.qty or 0) | float %}\r\n      {% set rate = (row.rate or 0) | float %}\r\n      {% set disc = (row.discount_pct or 0) | float %}\r\n      {% if disc < 0 %}{% set disc = 0 %}{% endif %}\r\n      {% if disc > 100 %}{% set disc = 100 %}{% endif %}\r\n      {% set base = (qty * rate * (1 - (disc/100.0))) | float %}\r\n      {% set iva_line = (base * (pct/100.0)) | float %}\r\n\r\n      {# Acumular #}\r\n      {% set ns.subtotal = ns.subtotal + base %}\r\n      {% set ns.ivatotal = ns.ivatotal + iva_line %}\r\n      {% if pct|int == 0 %}\r\n        {% set ns.base0 = ns.base0 + base %}{% set ns.iva0 = ns.iva0 + iva_line %}\r\n      {% elif pct|int == 5 %}\r\n        {% set ns.base5 = ns.base5 + base %}{% set ns.iva5 = ns.iva5 + iva_line %}\r\n      {% elif pct|int == 12 %}\r\n        {% set ns.base12 = ns.base12 + base %}{% set ns.iva12 = ns.iva12 + iva_line %}\r\n      {% elif pct|int == 13 %}\r\n        {% set ns.base13 = ns.base13 + base %}{% set ns.iva13 = ns.iva13 + iva_line %}\r\n      {% elif pct|int == 14 %}\r\n        {% set ns.base14 = ns.base14 + base %}{% set ns.iva14 = ns.iva14 + iva_line %}\r\n      {% elif pct|int == 15 %}\r\n        {% set ns.base15 = ns.base15 + base %}{% set ns.iva15 = ns.iva15 + iva_line %}\r\n      {% endif %}\r\n\r\n      {% set desc_txt = row.item_name or row.description or row.item_code %}\r\n      <tr>\r\n        <td class=\"t\">{{ row.item_code }}</td>\r\n        <td class=\"t\" style=\"text-align:right;\">{{ qty }}</td>\r\n        <td class=\"t\">{{ desc_txt }}</td>\r\n        <td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(rate) }}</td>\r\n        <td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(((qty * rate) - base) if disc>0 else 0.0) }}</td>\r\n        <td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(base) }}</td>\r\n      </tr>\r\n    {% endfor %}\r\n  </tbody>\r\n</table>\r\n\r\n<!-- Pagos y Totales -->\r\n<div style=\"margin-top:15px; overflow:hidden;\">\r\n  <!-- Pagos -->\r\n  <div style=\"width:48%; float:left;\">\r\n    <table style=\"width:100%; border-collapse:collapse; font-size:10px;\">\r\n      <thead>\r\n        <tr style=\"background-color:#eaeaea; font-weight:bold;\">\r\n          <th class=\"t\">Forma de Pago</th>\r\n          <th class=\"t\">Valor</th>\r\n        </tr>\r\n      </thead>\r\n      <tbody>\r\n        {% if doc.payments and doc.payments|length > 0 %}\r\n          {% for p in doc.payments %}\r\n            <tr>\r\n              <td class=\"t\">{{ p.forma_pago or p.method or '\u2014' }}</td>\r\n              <td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(p.monto or doc.grand_total or (ns.subtotal + ns.ivatotal)) }}</td>\r\n            </tr>\r\n          {% endfor %}\r\n        {% else %}\r\n          <tr>\r\n            <td class=\"t\">Pago</td>\r\n            <td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(doc.grand_total if doc.grand_total is not none else (ns.subtotal + ns.ivatotal)) }}</td>\r\n          </tr>\r\n        {% endif %}\r\n      </tbody>\r\n    </table>\r\n  </div>\r\n\r\n  <!-- Totales -->\r\n  <div style=\"width:48%; float:right;\">\r\n    <table style=\"width:100%; border-collapse:collapse; font-size:10px;\">\r\n\r\n      {# Subtotales por tasa (solo si hay base) #}\r\n      {% if ns.base15 > 0 %}<tr><td class=\"t\">Subtotal 15%</td><td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(ns.base15) }}</td></tr>{% endif %}\r\n      {% if ns.base14 > 0 %}<tr><td class=\"t\">Subtotal 14%</td><td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(ns.base14) }}</td></tr>{% endif %}\r\n      {% if ns.base13 > 0 %}<tr><td class=\"t\">Subtotal 13%</td><td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(ns.base13) }}</td></tr>{% endif %}\r\n      {% if ns.base12 > 0 %}<tr><td class=\"t\">Subtotal 12%</td><td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(ns.base12) }}</td></tr>{% endif %}\r\n      {% if ns.base5  > 0 %}<tr><td class=\"t\">Subtotal 5%</td><td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(ns.base5) }}</td></tr>{% endif %}\r\n      {% if ns.base0  > 0 %}<tr><td class=\"t\">Subtotal 0%</td><td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(ns.base0) }}</td></tr>{% endif %}\r\n\r\n      <tr>\r\n        <td class=\"t\">Subtotal (sin impuestos)</td>\r\n        <td class=\"t\" style=\"text-align:right;\">\r\n          {{ \"%.2f\"|format(doc.total_without_tax if doc.total_without_tax is not none else ns.subtotal) }}\r\n        </td>\r\n      </tr>\r\n\r\n      <tr><td class=\"t\">Descuento</td><td class=\"t\" style=\"text-align:right;\">0.00</td></tr>\r\n\r\n      {# IVA por tasa (omite 0%) #}\r\n      {% if ns.iva15 > 0 %}<tr><td class=\"t\">IVA 15%</td><td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(ns.iva15) }}</td></tr>{% endif %}\r\n      {% if ns.iva14 > 0 %}<tr><td class=\"t\">IVA 14%</td><td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(ns.iva14) }}</td></tr>{% endif %}\r\n      {% if ns.iva13 > 0 %}<tr><td class=\"t\">IVA 13%</td><td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(ns.iva13) }}</td></tr>{% endif %}\r\n      {% if ns.iva12 > 0 %}<tr><td class=\"t\">IVA 12%</td><td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(ns.iva12) }}</td></tr>{% endif %}\r\n      {% if ns.iva5  > 0 %}<tr><td class=\"t\">IVA 5%</td><td class=\"t\" style=\"text-align:right;\">{{ \"%.2f\"|format(ns.iva5) }}</td></tr>{% endif %}\r\n\r\n      <tr>\r\n        <td class=\"t\"><strong>Valor Total</strong></td>\r\n        <td class=\"t\" style=\"text-align:right;\">\r\n          <strong>{{ \"%.2f\"|format(doc.grand_total if doc.grand_total is not none else (ns.subtotal + ns.ivatotal)) }}</strong>\r\n        </td>\r\n      </tr>\r\n    </table>\r\n  </div>\r\n</div>\r\n",
 "idx": 0,
 "line_breaks": 0,
 "margin_bottom": 15.0,
 "margin_left": 15.0,
 "margin_right": 15.0,
 "margin_top": 15.0,
 "modified": "2025-09-09 22:50:11.580635",
 "modified_by": "Administrator",
 "module": "Facturacion BMARC",
 "name": "Sales Invoice",
 "owner": "Administrator",
 "page_number": "Hide",
 "pdf_generator": "wkhtmltopdf",
 "print_format_builder": 0,
 "print_format_builder_beta": 0,
 "print_format_type": "Jinja",
 "raw_printing": 0,
 "show_section_headings": 0,
 "standard": "Yes"
}